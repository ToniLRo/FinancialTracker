<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">

</head>
<div class="content">
    <div class="header">
        <div class="title">
            <h2>My Wallets</h2>
        </div>
    </div>
    <div class="content-container text-white">
        <div class="actions"> 
            <div class="action-button">
                <button class="button-27" role="button" title="Add Card" 
                [disabled]="isProcessing"
                (click)="openAddForm()"
                [class.processing]="isProcessing">
                    <i class="bi bi-plus-circle" style="color: white; font-size: 25px;"></i>
                </button>
                <div class="button-description"  style="text-align: center;">
                    Add Card
                </div>
            </div>
            <div class="action-button">
                <button class="button-27" role="button" title="Edit Card" 
                [disabled]="!getActiveAccount() || isProcessing" 
                (click)="openEditFormForActiveAccount()"
                [class.processing]="isProcessing">
                        <i class="bi bi-pencil-square" style="color: white; font-size: 25px;"></i>
                </button>
                <div class="button-description"  style="text-align: center;">
                    Edit Card
                </div>
            </div>
            <div class="action-button">
                <button class="button-27" role="button" title="Delete Card" 
                [disabled]="!getActiveAccount() || isProcessing" 
                (click)="deleteActiveAccount()"
                [class.processing]="isProcessing"
                [class.danger]="true">
                    <i class="bi bi-trash" style="color: white; font-size: 25px;"></i>
                </button>
                <div class="button-description"  style="text-align: center;">
                    Delete Card
                </div>
            </div>
            <div class="action-button">
              <button class="button-27" role="button" title="View Details" 
                      [disabled]="!getActiveAccount() || isProcessing" 
                      (click)="openInspectModal()">
                <i class="bi bi-eye" style="color: white; font-size: 25px;"></i>
              </button>
              <div class="button-description" style="text-align: center;">
                View Details
              </div>
            </div>
            <div class="action-button">
                <button title="Add Transaction/Transfer" class="button-27" role="button" [disabled]="!selectedAccount" (click)="openTransactionForm(selectedAccount!)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                    </svg>
                </button>
                <div class="button-description">
                    Add Transaction/Transfer
                </div>
            </div>
            <div class="action-button">
                <button title="Withdraw" class="button-27" role="button" 
                [disabled]="!getActiveAccount() || isProcessing"
                (click)="openWithdrawModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-reply-all-fill" viewBox="0 0 16 16">
                        <path d="M8.021 11.9 3.453 8.62a.72.72 0 0 1 0-1.238L8.021 4.1a.716.716 0 0 1 1.079.619V6c1.5 0 6 0 7 8-2.5-4.5-7-4-7-4v1.281c0 .56-.606.898-1.079.62z"/>
                        <path d="M5.232 4.293a.5.5 0 0 1-.106.7L1.114 7.945l-.042.028a.147.147 0 0 0 0 .252l.042.028 4.012 2.954a.5.5 0 1 1-.593.805L.539 9.073a1.147 1.147 0 0 1 0-1.946l3.994-2.94a.5.5 0 0 1 .699.106"/>
                    </svg>
                </button>
                <div class="button-description"  style="text-align: center;">
                    Withdraw
                </div>
            </div>
            <div class="action-button">
                    <button title="Deposit" class="button-27" role="button" 
                    [disabled]="!getActiveAccount() || isProcessing"
                    (click)="openDepositModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-cash-stack" viewBox="0 0 16 16">
                            <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/>
                            <path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V7a2 2 0 0 1-2-2z"/>
                        </svg>
                    </button>
                <div class="button-description"  style="text-align: center;">
                    Deposit
                </div>
            </div>
        </div>
        <div class="mycards">
            <div class="slide-container swiper">
                <h5 style="text-align: center;">My Cards</h5>
                
                <!-- Mensaje cuando no hay accounts -->
                <div *ngIf="accounts.length === 0" class="no-cards-message">
                    <div class="no-cards-content">
                        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" class="no-cards-icon" viewBox="0 0 16 16">
                            <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/>
                            <path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V7a2 2 0 0 1-2-2z"/>
                        </svg>
                        <h3>No Cards Found</h3>
                        <p>You don't have any cards yet. Add your first card to get started!</p>
                    </div>
                </div>

                <!-- Swiper solo se muestra si hay accounts -->
                <div class="slide-content" *ngIf="accounts.length > 0">
                    <div class="card-wrapper swiper-wrapper">
                        <div *ngFor="let account of accounts; let i = index" class="card swiper-slide" [class.selected]="account === selectedAccount" (click)="selectAccount(account, i)">
                        <div class="card-inner">
                            <div class="card-front">  
                            <div class="card-bg"></div>
                            <div class="card-glow"></div>
                            <svg
                                width="72"
                                height="24"
                                viewBox="0 0 72 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                class="logo"
                            >
                                <path
                                fill-rule="evenodd"
                                clip-rule="evenodd"
                                d="M52.3973 1.01093L51.5588 5.99054C49.0448 4.56717 43.3231 4.23041 43.3231 6.85138C43.3231 7.89285 44.6177 8.60913 46.178 9.47241C48.5444 10.7817 51.5221 12.4291 51.5221 16.062C51.5221 21.8665 45.4731 24 41.4645 24C37.4558 24 34.8325 22.6901 34.8325 22.6901L35.7065 17.4848C38.1115 19.4688 45.4001 20.032 45.4001 16.8863C45.4001 15.5645 43.9656 14.785 42.3019 13.8811C40.0061 12.6336 37.2742 11.1491 37.2742 7.67563C37.2742 1.30988 44.1978 0 47.1132 0C49.8102 0 52.3973 1.01093 52.3973 1.01093ZM66.6055 23.6006H72L67.2966 0.414276H62.5732C60.3923 0.414276 59.8612 2.14215 59.8612 2.14215L51.0996 23.6006H57.2234L58.4481 20.1566H65.9167L66.6055 23.6006ZM60.1406 15.399L63.2275 6.72235L64.9642 15.399H60.1406ZM14.7942 16.3622L20.3951 0.414917H26.7181L17.371 23.6012H11.2498L6.14551 3.45825C2.83215 1.41281 0 0.807495 0 0.807495L0.108643 0.414917H9.36816C11.9161 0.414917 12.1552 2.50314 12.1552 2.50314L14.1313 12.9281L14.132 12.9294L14.7942 16.3622ZM25.3376 23.6006H31.2126L34.8851 0.414917H29.0095L25.3376 23.6006Z"
                                fill="white"
                                />
                            </svg>
                            <div class="card-contactless">
                                <svg xmlns="http://www.w3.org/2000/svg" width="46" height="56">
                                <path
                                    fill="none"
                                    stroke="#f9f9f9"
                                    stroke-width="6"
                                    stroke-linecap="round"
                                    d="m35,3a50,50 0 0,1 0,50M24,8.5a39,39 0 0,1 0,39M13.5,13.55a28.2,28.5
                        0 0,1 0,28.5M3,19a18,17 0 0,1 0,18"
                                />
                                </svg>
                            </div>
                            <div class="card-chip"></div>
                                    <div class="card-holder" [title]="account.holder_name">
                                        {{ truncateText(account.holder_name, 12) }}
                            </div>
                                    <div class="card-number">{{ formatCardNumber(account.account_number, account.account_type) }}</div>
                                    <div class="card-valid">{{ formatValidThru(account) }}</div>
                                    <div class="card-balance" style="position: absolute; bottom: 10px; right: 15px; font-size: 12px; color: #fff;">
                                        {{ account.balance | currency:account.currency }}
                            </div>
                                    <div class="card-type" style="position: absolute; top: 10px; left: 15px; background: rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px;">
                                        {{ account.account_type }}
                        </div>
                            </div>
                            <div class="card-back">
                                    <div class="card-signature">{{ account.holder_name }}</div>
                            <div class="card-seccode">123</div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                <div class="swiper-button-next swiper-navBtn" *ngIf="accounts.length > 0"></div>
                <div class="swiper-button-prev swiper-navBtn" *ngIf="accounts.length > 0"></div>
                <div class="swiper-pagination" *ngIf="accounts.length > 0"></div>
            </div>
        </div>
        <div class="transactions-data text-white">
            <h2>Latest Transactions</h2>
            <h3>Today</h3>
            <div class="transactions">
                <div *ngFor="let transaction of activeAccountTransactions; trackBy: trackByTransactionId" class="transaction-item">
                    <details>
                        <summary>
                            <div class="transaction-header">
                                <!-- Icono dinámico según el tipo -->
                                <span class="transaction-icon-container" 
                                      [style.background-color]="getTransactionIconColor(transaction.type)">
                                    <i [class]="getTransactionIcon(transaction.type)" 
                                       [ngClass]="getTransactionIconClass(transaction.type)"></i>
                                </span>
                                <div class="transaction-info">
                                    <h3>
                                        <strong>{{ transaction.description }}</strong>
                                        <small>{{ transaction.type }}</small>
                                    </h3>
                                    <span [class.plus]="transaction.amount > 0" [class.minus]="transaction.amount < 0">
                                        {{ transaction.amount > 0 ? '+' : '' }}{{ transaction.amount | currency:'USD' }}
                                    </span>
                                </div>
                                <!-- NUEVO: Botones de acción -->
                                <div class="transaction-actions">
                                    <button 
                                        class="btn-edit-transaction" 
                                        title="Edit Transaction"
                                        (click)="openEditTransactionModal(transaction, $event)"
                                        [disabled]="isProcessing">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <button 
                                        class="btn-delete-transaction" 
                                        title="Delete Transaction"
                                        (click)="deleteTransaction(transaction, $event)"
                                        [disabled]="isProcessing">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </summary>
                        <div class="transaction-details">
                            <dl>
                                <div>
                                    <dt>Date</dt>
                                    <dd>{{ transaction.date | date:'shortDate' }}</dd>
                                </div>
                                <div>
                                    <dt>Card used</dt>
                                    <dd>•••• {{ getActiveAccount()?.account_type?.slice(-4) }}</dd>
                                </div>
                                <div>
                                    <dt>Reference ID</dt>
                                    <dd>{{ transaction.reference_id || getCurrentReferenceId() }}</dd>
                                </div>
                                <div>
                                    <dt>Category</dt>
                                    <dd>
                                        <span class="transaction-category">
                                            <i [class]="getTransactionIcon(transaction.type)"></i>
                                            {{ transaction.type }}
                                        </span>
                                    </dd>
                                </div>
                            </dl>
                        </div>
                    </details>
                </div>
                
                <!-- Mensaje cuando no hay transacciones -->
                <div *ngIf="!activeAccountTransactions?.length" class="no-transactions">
                    <i class="bi bi-inbox" style="font-size: 48px; opacity: 0.5; margin-bottom: 10px;"></i>
                    <p>No transactions found for this card.</p>
                </div>
            </div>
        </div>

<!-- NUEVO: Modal para editar transacciones -->
<div class="modal" *ngIf="showEditTransactionModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Transaction</h3>
            <button type="button" class="close-btn" (click)="closeEditTransactionModal()" [disabled]="isProcessing">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <form (ngSubmit)="saveEditedTransaction()" #editTransactionForm="ngForm">
            <div class="form-group">
                <label for="edit_transaction_date">Date *</label>
                <input 
                    id="edit_transaction_date"
                    type="date" 
                    [(ngModel)]="editingTransaction.date" 
                    name="edit_transaction_date" 
                    required
                    [disabled]="isProcessing"
                    #editDate="ngModel">
                <div class="validation-message" *ngIf="editDate.invalid && editDate.touched">
                    <small *ngIf="editDate.errors?.['required']">Date is required</small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="edit_transaction_description">Description *</label>
                <input 
                    id="edit_transaction_description"
                    [(ngModel)]="editingTransaction.description" 
                    name="edit_transaction_description" 
                    required
                    maxlength="100"
                    placeholder="Transaction description"
                    [disabled]="isProcessing"
                    #editDescription="ngModel">
                <div class="validation-message" *ngIf="editDescription.invalid && editDescription.touched">
                    <small *ngIf="editDescription.errors?.['required']">Description is required</small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="edit_transaction_amount">Amount *</label>
                <input 
                    id="edit_transaction_amount"
                    type="number" 
                    [(ngModel)]="editingTransaction.amount" 
                    name="edit_transaction_amount" 
                    required
                    step="0.01"
                    placeholder="0.00"
                    [disabled]="isProcessing"
                    #editAmount="ngModel">
                <div class="validation-message" *ngIf="editAmount.invalid && editAmount.touched">
                    <small *ngIf="editAmount.errors?.['required']">Amount is required</small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="edit_transaction_type">Type *</label>
                <select 
                    id="edit_transaction_type"
                    [(ngModel)]="editingTransaction.type" 
                    name="edit_transaction_type" 
                    required
                    [disabled]="isProcessing">
                    <option value="">Select transaction type</option>
                    <option value="Food">Food</option>
                    <option value="Transport">Transport</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Income">Income</option>
                    <option value="Gift">Gift</option>
                    <option value="Bills">Bills</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Education">Education</option>
                </select>
            </div>
            
            <!-- Error Messages -->
            <div class="error-message" *ngIf="transactionEditError">
                {{ transactionEditError }}
            </div>
            
            <!-- Action Buttons -->
            <div class="modal-buttons">
                <button 
                    type="submit" 
                    class="btn btn-success" 
                    [disabled]="!editTransactionForm.valid || isProcessing">
                    <span *ngIf="isProcessing" class="spinner"></span>
                    {{ isProcessing ? 'Saving...' : 'Save Changes' }}
                </button>
                <button 
                    type="button" 
                    class="btn btn-secondary" 
                    (click)="closeEditTransactionModal()"
                    [disabled]="isProcessing">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- NUEVO: Modal de confirmación para eliminar transacción -->
<div class="modal" *ngIf="showDeleteTransactionModal">
    <div class="modal-content delete-confirmation-modal">
        <div class="modal-header">
            <h3>
                <i class="bi bi-exclamation-triangle text-danger"></i>
                Delete Transaction
            </h3>
            <button type="button" class="close-btn" (click)="closeDeleteTransactionModal()" [disabled]="isProcessing">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="confirmation-content">
            <p>Are you sure you want to delete this transaction?</p>
            <div class="transaction-preview" *ngIf="transactionToDelete">
                <div class="transaction-summary">
                    <span class="transaction-description">{{ transactionToDelete.description }}</span>
                    <span class="transaction-amount" [class.plus]="transactionToDelete.amount > 0" [class.minus]="transactionToDelete.amount < 0">
                        {{ transactionToDelete.amount > 0 ? '+' : '' }}{{ transactionToDelete.amount | currency:'USD' }}
                    </span>
                </div>
                <div class="transaction-details-preview">
                    <small>{{ transactionToDelete.type }} • {{ transactionToDelete.date | date:'shortDate' }}</small>
                </div>
            </div>
            <p class="warning-text">This action cannot be undone.</p>
        </div>
        
        <!-- Error Messages -->
        <div class="error-message" *ngIf="transactionDeleteError">
            {{ transactionDeleteError }}
        </div>
        
        <!-- Action Buttons -->
        <div class="modal-buttons">
            <button 
                type="button" 
                class="btn btn-danger" 
                (click)="confirmDeleteTransaction()"
                [disabled]="isProcessing">
                <span *ngIf="isProcessing" class="spinner"></span>
                <i class="bi bi-trash" *ngIf="!isProcessing"></i>
                {{ isProcessing ? 'Deleting...' : 'Delete Transaction' }}
            </button>
            <button 
                type="button" 
                class="btn btn-secondary" 
                (click)="closeDeleteTransactionModal()"
                [disabled]="isProcessing">
                Cancel
            </button>
        </div>
    </div>
</div>
                            </div>
                            
  
<!-- Modal for Add/Edit Account mejorado -->
<div class="modal" *ngIf="showForm">
    <div class="modal-content">
      <div class="modal-header">
        <h3>{{ isEdit ? 'Edit Card' : 'Add New Card' }}</h3>
        <button type="button" class="close-btn" (click)="closeForm()" [disabled]="isProcessing">
          <i class="bi bi-x-lg"></i>
        </button>
                            </div>
                            
      <form (ngSubmit)="saveAccount(selectedAccount!)" #accountForm="ngForm">
                <!-- Holder Name -->
                <div class="form-group">
                    <label for="holder_name">Card Holder *</label>
                    <input 
                      id="holder_name"
                      [(ngModel)]="selectedAccount!.holder_name" 
                      name="holder_name" 
                      required 
                      maxlength="50"
                      placeholder="e.g., John Doe"
                      [disabled]="isProcessing"
                      #holderName="ngModel">
                    <div class="validation-message" *ngIf="holderName.invalid && holderName.touched">
                      <small *ngIf="holderName.errors?.['required']">Holder name is required</small>
                    </div>
                  </div>
                  
        <!-- Card Type -->
        <div class="form-group">
          <label for="account_type">Card Type *</label>
          <select 
            id="account_type"
            [(ngModel)]="selectedAccount!.account_type" 
            name="account_type" 
            required
            [disabled]="isProcessing"
            (change)="onAccountTypeChange()">
            <option value="">Select card type</option>
            <option value="CreditCard">Credit Card</option>
            <option value="BankAccount">Bank Account</option>
            <option value="Cash">Cash</option>
          </select>
        </div>
        
        <!-- Card Number con máscara mejorada -->
        <div class="form-group">
          <label for="account_number">
            {{ selectedAccount?.account_type === 'CreditCard' ? 'Card Number' : 
               selectedAccount?.account_type === 'BankAccount' ? 'Account Number' : 
               'Cash ID' }} *
          </label>
          <div class="input-with-actions">
            <input 
              id="account_number"
              [(ngModel)]="selectedAccount!.account_number" 
              name="account_number"     
              required 
              [maxlength]="getAccountNumberMaxLength(selectedAccount?.account_type || 'CreditCard')"
              [placeholder]="getAccountNumberPlaceholder(selectedAccount?.account_type || 'CreditCard')"
              [disabled]="isProcessing"
              (input)="onAccountNumberInput($event)"
              #accountNumber="ngModel"
              autocomplete="off"
              class="account-number-input">
          </div>
          <div class="validation-message" *ngIf="accountNumber.invalid && accountNumber.touched">
            <small *ngIf="accountNumber.errors?.['required']">
              {{ selectedAccount?.account_type === 'CreditCard' ? 'Card number' : 
                 selectedAccount?.account_type === 'BankAccount' ? 'Account number' : 
                 'Cash ID' }} is required
            </small>
          </div>
          <div class="validation-message" *ngIf="selectedAccount && selectedAccount.account_number && selectedAccount.account_type && !validateAccountNumber(selectedAccount.account_number, selectedAccount.account_type)">
            <small class="error">           
              Invalid {{ selectedAccount.account_type === 'CreditCard' ? 'card' : 
                 selectedAccount.account_type === 'BankAccount' ? 'account' : 
                 'cash ID' }} number format
            </small>
          </div>
          <div class="format-hint">
            <small>
              Format: {{ getAccountNumberPlaceholder(selectedAccount?.account_type || 'CreditCard') }}
            </small>
          </div>
        </div>
        
        <!-- Balance -->
        <div class="form-group">
          <label for="balance">{{ isEdit ? 'Current Balance' : 'Initial Balance' }} *</label>
          <input 
            id="balance"
            type="number" 
            [(ngModel)]="selectedAccount!.balance" 
            name="balance" 
            required 
            step="0.01"
            min="0"
            placeholder="0.00"
            [disabled]="isProcessing"
            #balance="ngModel">
          <div class="validation-message" *ngIf="balance.invalid && balance.touched">
            <small *ngIf="balance.errors?.['required']">Balance is required</small>
            <small *ngIf="balance.errors?.['min']">Balance cannot be negative</small>
          </div>
        </div>
        
        <!-- Currency -->
        <div class="form-group">
          <label for="currency">Currency *</label>
          <select 
            id="currency"
            [(ngModel)]="selectedAccount!.currency" 
            name="currency" 
            required
            [disabled]="isProcessing">
            <option value="">Select currency</option>
            <option value="USD">USD - US Dollar</option>
            <option value="EUR">EUR - Euro</option>
            <option value="GBP">GBP - British Pound</option>
            <option value="JPY">JPY - Japanese Yen</option>
            <option value="CAD">CAD - Canadian Dollar</option>
          </select>
        </div>
        
        <!-- Good Thru (Valid Until) -->
        <div class="form-group" *ngIf="selectedAccount?.account_type === 'CreditCard' || selectedAccount?.account_type === 'BankAccount'">
          <label for="good_thru">Valid Until (MM/YY) *</label>
          <div class="input-with-actions">
            <input 
              id="good_thru"
              [(ngModel)]="selectedAccount!.good_thru" 
              name="good_thru"     
              required 
              maxlength="5"
              placeholder="MM/YY"
              [disabled]="isProcessing"
              (input)="onGoodThruInput($event)"
              #goodThru="ngModel"
              autocomplete="off"
              class="good-thru-input">
          </div>
          <div class="validation-message" *ngIf="goodThru.invalid && goodThru.touched">
            <small *ngIf="goodThru.errors?.['required']">
              Valid until date is required
            </small>
          </div>
          <div class="validation-message" *ngIf="selectedAccount && selectedAccount.good_thru && !validateGoodThru(selectedAccount.good_thru)">
            <small class="error">           
              Invalid date format or expired date (use MM/YY)
            </small>
          </div>
          <div class="format-hint">
            <small>
              Format: MM/YY (e.g., 12/27 for December 2027)
            </small>
          </div>
        </div>
        
        <!-- Error Messages -->
        <div class="error-message" *ngIf="accountError">
          {{ accountError }}
        </div>
        
        <!-- Action Buttons -->
        <div class="modal-buttons">
          <button 
            type="submit" 
            class="btn btn-success" 
            [disabled]="!accountForm.valid || isProcessing">
            <span *ngIf="isProcessing" class="spinner"></span>
            {{ isProcessing ? 'Saving...' : (isEdit ? 'Save Changes' : 'Add Card') }}
          </button>
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="closeForm()"
            [disabled]="isProcessing">
            Cancel
          </button>
        </div>
      </form>
    </div>
</div>
  
  <!-- Modal for Add Transaction -->
  <div class="modal" *ngIf="showTransactionForm">
    <div class="modal-content">
      <h3>Add Transaction</h3>
      <form (ngSubmit)="saveTransaction()">
        <label>Date</label>
        <input type="date" [(ngModel)]="transactionForm.date" name="date" required>
        <label>Description</label>
        <input [(ngModel)]="transactionForm.description" name="description" required>
        <label>Amount</label>
        <input type="number" [(ngModel)]="transactionForm.amount" name="amount" required>
        <label>Type</label>
        <select [(ngModel)]="transactionForm.type" name="type" required>
          <option value="Food">Food</option>
          <option value="Transport">Transport</option>
          <option value="Shopping">Shopping</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Income">Income</option>
          <option value="Gift">Gift</option>
          <option value="Bills">Bills</option>
          <option value="Healthcare">Healthcare</option>
          <option value="Education">Education</option>
          <!-- NO incluir Withdraw ni Deposit aquí -->
        </select>
        <button type="submit" class="btn btn-success">Add</button>
        <button type="button" class="btn btn-secondary" (click)="closeAllForms()">Cancel</button>
      </form>
    </div>
  </div>

<!-- Modal for Withdraw -->
<div class="modal" *ngIf="showWithdrawModal">
    <div class="modal-content withdraw-modal">
      <div class="modal-header">
        <h3>
          <i class="bi bi-arrow-down-circle text-danger"></i>
          Withdraw Money
                            </h3>
        <button type="button" class="close-btn" (click)="closeWithdrawModal()" [disabled]="isProcessing">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="account-info" *ngIf="getActiveAccount()">
        <div class="account-summary">
          <span class="account-name">{{ getActiveAccount()?.holder_name }}</span>
          <span class="account-balance">
            Current Balance: {{ getActiveAccount()?.balance | currency:getActiveAccount()?.currency }}
          </span>
        </div>
      </div>
      
      <form (ngSubmit)="processWithdraw()" #withdrawFormRef="ngForm">
        <div class="form-group">
          <label for="withdraw_amount">Amount to Withdraw *</label>
          <div class="amount-input-container">
            <span class="currency-symbol">{{ getActiveAccount()?.currency || 'USD' }}</span>
            <input 
              id="withdraw_amount"
              type="number" 
              [(ngModel)]="withdrawForm.amount" 
              name="withdraw_amount" 
              required 
              min="0.01"
              max="999999"
              step="0.01"
              placeholder="0.00"
              [disabled]="isProcessing"
              #withdrawAmount="ngModel"
              class="amount-input">
          </div>
          <div class="validation-message" *ngIf="withdrawAmount.invalid && withdrawAmount.touched">
            <small *ngIf="withdrawAmount.errors?.['required']">Amount is required</small>
            <small *ngIf="withdrawAmount.errors?.['min']">Amount must be greater than 0</small>
            <small *ngIf="withdrawAmount.errors?.['max']">Amount cannot exceed 999,999</small>
          </div>
                        </div>
        
        <div class="form-group">
          <label for="withdraw_description">Description (Optional)</label>
          <input 
            id="withdraw_description"
            [(ngModel)]="withdrawForm.description" 
            name="withdraw_description" 
            maxlength="100"
            placeholder="e.g., ATM Withdrawal, Cash needed"
            [disabled]="isProcessing"
            class="description-input">
                            </div>
                            
        <!-- New Balance Preview for Withdraw -->
        <div class="balance-preview-withdraw" *ngIf="withdrawForm.amount > 0 && withdrawForm.amount <= (getActiveAccount()?.balance || 0)">
          <i class="bi bi-arrow-down"></i>
          <span>New Balance: {{ (getActiveAccount()?.balance || 0) - withdrawForm.amount | currency:getActiveAccount()?.currency }}</span>
                            </div>
                            
        <!-- Available Balance Warning -->
        <div class="balance-warning" *ngIf="withdrawForm.amount > (getActiveAccount()?.balance || 0)">
          <i class="bi bi-exclamation-triangle"></i>
          <span>Insufficient funds! Available: {{ getActiveAccount()?.balance | currency:getActiveAccount()?.currency }}</span>
                            </div>
        
        <!-- Error Messages -->
        <div class="error-message" *ngIf="withdrawError">
          {{ withdrawError }}
                    </div>
        
        <!-- Action Buttons -->
        <div class="modal-buttons">
          <button 
            type="submit" 
            class="btn btn-danger" 
            [disabled]="!withdrawFormRef.valid || isProcessing || withdrawForm.amount > (getActiveAccount()?.balance || 0)">
            <span *ngIf="isProcessing" class="spinner"></span>
            <i class="bi bi-arrow-down-circle" *ngIf="!isProcessing"></i>
            {{ isProcessing ? 'Processing...' : 'Withdraw' }}
          </button>
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="closeWithdrawModal()"
            [disabled]="isProcessing">
            Cancel
          </button>
            </div>
      </form>
    </div>
</div>

<!-- NUEVO: Modal de Inspect Mode con fondo opaco -->
<div class="modal" *ngIf="showInspectModal" style="background-color: rgba(0, 0, 0, 0.9) !important; backdrop-filter: blur(5px);">
    <div class="modal-content inspect-modal">
        <div class="modal-header">
            <h3>
                <i class="bi bi-eye text-info"></i>
                Account Details
            </h3>
            <button type="button" class="close-btn" (click)="closeInspectModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body" *ngIf="getActiveAccount()">
            <!-- Información de la cuenta -->
            <div class="account-details-section">
                <h4><i class="bi bi-info-circle me-2"></i>Account Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Account ID:</label>
                        <span>{{ getActiveAccount()?.account_Id }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Holder Name:</label>
                        <span>{{ getActiveAccount()?.holder_name }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Account Type:</label>
                        <span class="account-type-badge">{{ getActiveAccount()?.account_type }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Account Number:</label>
                        <span class="account-number">{{ formatCardNumber(getActiveAccount()?.account_number || '', getActiveAccount()?.account_type || '') }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Current Balance:</label>
                        <span class="balance" [class.positive]="(getActiveAccount()?.balance || 0) >= 0" [class.negative]="(getActiveAccount()?.balance || 0) < 0">
                            {{ getActiveAccount()?.balance | currency:getActiveAccount()?.currency }}
                        </span>
                    </div>
                    <div class="detail-item">
                        <label>Currency:</label>
                        <span>{{ getActiveAccount()?.currency }}</span>
                    </div>
                    <div class="detail-item" *ngIf="getActiveAccount()?.good_thru">
                        <label>Valid Until:</label>
                        <span>{{ getActiveAccount()?.good_thru }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Creation Date:</label>
                        <span>{{ getActiveAccount()?.creation_date | date:'mediumDate' }}</span>
                    </div>
                </div>
            </div>

            <!-- Estadísticas de la cuenta -->
            <div class="account-stats-section">
                <h4><i class="bi bi-graph-up me-2"></i>Account Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-arrow-up-circle text-success"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">{{ getTotalIncome() | currency:getActiveAccount()?.currency }}</div>
                            <div class="stat-label">Total Income</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-arrow-down-circle text-danger"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">{{ getTotalExpenses() | currency:getActiveAccount()?.currency }}</div>
                            <div class="stat-label">Total Expenses</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-graph-up text-info"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">{{ getActiveAccount()?.transactions?.length || 0 }}</div>
                            <div class="stat-label">Total Transactions</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-calendar-event text-warning"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">{{ getDaysSinceCreation() }}</div>
                            <div class="stat-label">Days Active</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transacciones recientes -->
            <div class="recent-transactions-section">
                <h4><i class="bi bi-clock-history me-2"></i>Recent Transactions (Last 5)</h4>
                <div class="transactions-list" *ngIf="getActiveAccount()?.transactions?.length; else noTransactions">
                    <div *ngFor="let transaction of getRecentTransactions()" class="transaction-item">
                        <div class="transaction-icon">
                            <i [class]="getTransactionIcon(transaction.type)" 
                               [style.color]="getTransactionIconColor(transaction.type)"></i>
                        </div>
                        <div class="transaction-info">
                            <div class="transaction-description">{{ transaction.description }}</div>
                            <div class="transaction-meta">
                                {{ transaction.type }} • {{ transaction.date | date:'shortDate' }}
                            </div>
                        </div>
                        <div class="transaction-amount" [class.positive]="transaction.amount > 0" [class.negative]="transaction.amount < 0">
                            {{ transaction.amount > 0 ? '+' : '' }}{{ transaction.amount | currency:getActiveAccount()?.currency }}
                        </div>
                    </div>
                </div>
                <ng-template #noTransactions>
                    <div class="no-transactions">
                        <i class="bi bi-inbox"></i>
                        <p>No transactions found for this account.</p>
                    </div>
                </ng-template>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeInspectModal()">
                <i class="bi bi-x-lg me-1"></i>Close
            </button>
            <button type="button" class="btn btn-primary" (click)="openEditFormForActiveAccount(); closeInspectModal()">
                <i class="bi bi-pencil-square me-1"></i>Edit Account
            </button>
        </div>
    </div>
</div>


<!-- Modal for Deposit -->
<div class="modal" *ngIf="showDepositModal">
    <div class="modal-content deposit-modal">
      <div class="modal-header">
        <h3>
          <i class="bi bi-arrow-up-circle text-success"></i>
          Deposit Money
        </h3>
        <button type="button" class="close-btn" (click)="closeDepositModal()" [disabled]="isProcessing">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="account-info" *ngIf="getActiveAccount()">
        <div class="account-summary">
          <span class="account-name">{{ getActiveAccount()?.holder_name }}</span>
          <span class="account-balance">
            Current Balance: {{ getActiveAccount()?.balance | currency:getActiveAccount()?.currency }}
          </span>
        </div>
      </div>
      
      <form (ngSubmit)="processDeposit()" #depositFormRef="ngForm">
        <div class="form-group">
          <label for="deposit_amount">Amount to Deposit *</label>
          <div class="amount-input-container">
            <span class="currency-symbol">{{ getActiveAccount()?.currency || 'USD' }}</span>
            <input 
              id="deposit_amount"
              type="number" 
              [(ngModel)]="depositForm.amount" 
              name="deposit_amount" 
              required 
              min="0.01"
              max="999999"
              step="0.01"
              placeholder="0.00"
              [disabled]="isProcessing"
              #depositAmount="ngModel"
              class="amount-input">
          </div>
          <div class="validation-message" *ngIf="depositAmount.invalid && depositAmount.touched">
            <small *ngIf="depositAmount.errors?.['required']">Amount is required</small>
            <small *ngIf="depositAmount.errors?.['min']">Amount must be greater than 0</small>
            <small *ngIf="depositAmount.errors?.['max']">Amount cannot exceed 999,999</small>
          </div>
        </div>
        
        <div class="form-group">
          <label for="deposit_description">Description (Optional)</label>
          <input 
            id="deposit_description"
            [(ngModel)]="depositForm.description" 
            name="deposit_description" 
            maxlength="100"
            placeholder="e.g., Cash Deposit, Salary, Gift"
            [disabled]="isProcessing"
            class="description-input">
        </div>
        
        <!-- New Balance Preview -->
        <div class="balance-preview" *ngIf="depositForm.amount > 0">
          <i class="bi bi-arrow-right"></i>
          <span>New Balance: {{ (getActiveAccount()?.balance || 0) + depositForm.amount | currency:getActiveAccount()?.currency }}</span>
        </div>
        
        <!-- Error Messages -->
        <div class="error-message" *ngIf="depositError">
          {{ depositError }}
        </div>
        
        <!-- Action Buttons -->
        <div class="modal-buttons">
          <button 
            type="submit" 
            class="btn btn-success" 
            [disabled]="!depositFormRef.valid || isProcessing">
            <span *ngIf="isProcessing" class="spinner"></span>
            <i class="bi bi-arrow-up-circle" *ngIf="!isProcessing"></i>
            {{ isProcessing ? 'Processing...' : 'Deposit' }}
          </button>
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="closeDepositModal()"
            [disabled]="isProcessing">
            Cancel
          </button>
        </div>
      </form>
    </div>
</div>