
<div class="content">
  <!-- Header -->
  <div class="header">
    <div class="title">
      <h2><i class="bi bi-credit-card me-2"></i>Payment History</h2>
      <p class="subtitle">All your transactions in one place</p>
    </div>
    <div class="stats">
      <div class="stat-card">
        <h6>Total Transactions</h6>
        <span class="stat-number">{{ filteredTransactions.length }}</span>
  </div>
      <div class="stat-card">
        <h6>Showing</h6>
        <span class="stat-number">{{ paginatedTransactions.length }}</span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-white">Loading transactions...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ error }}
    <button class="btn btn-outline-danger btn-sm ms-2" (click)="loadInitialData()">
      <i class="bi bi-arrow-clockwise me-1"></i>Retry
    </button>
  </div>

  <!-- Filters Section -->
  <div class="filters-section" *ngIf="!isLoading && !error">
    <div class="filters-header">
      <h5><i class="bi bi-funnel me-2"></i>Filters</h5>
      <button class="btn btn-outline-secondary btn-sm" (click)="clearFilters()">
        <i class="bi bi-eraser me-1"></i>Clear Filters
      </button>
    </div>
    
    <div class="filters-grid">
      <!-- Search by description -->
      <div class="filter-group">
        <label class="filter-label">Search Description</label>
        <div class="input-with-icon">
          <i class="bi bi-search icon"></i>
          <input 
            #searchInput
            type="text" 
            class="form-control" 
            placeholder="Search by description..." 
            [value]="filters.searchDescription || ''"
            (input)="onSearchChange($event)">
        </div>
      </div>

      <!-- Filter by account -->
      <div class="filter-group">
        <label class="filter-label">Account</label>
        <select 
          #accountSelect
          class="form-select" 
          [value]="filters.accountId || ''"
          (change)="onAccountFilterChange($event)">
          <option value="">All accounts</option>
          <option *ngFor="let account of accounts" [value]="account.account_Id">
            {{ account.holder_name }} - {{ account.account_number }}
          </option>
        </select>
      </div>

      <!-- Filter by type -->
      <div class="filter-group">
        <label class="filter-label">Transaction Type</label>
        <select 
          #typeSelect
          class="form-select" 
          [value]="filters.type || ''"
          (change)="onTypeFilterChange($event)">
          <option *ngFor="let type of transactionTypes" [value]="type === 'All' ? '' : type">
            {{ type }}
          </option>
        </select>
    </div>

      <!-- Date from -->
      <div class="filter-group">
        <label class="filter-label">Date From</label>
        <input 
          #dateFromInput
          type="date" 
          class="form-control" 
          [value]="filters.dateFrom || ''"
          (change)="onDateFromChange($event)">
      </div>

      <!-- Date to -->
      <div class="filter-group">
        <label class="filter-label">Date To</label>
        <input 
          #dateToInput
          type="date" 
          class="form-control" 
          [value]="filters.dateTo || ''"
          (change)="onDateToChange($event)">
    </div>

      <!-- Minimum amount -->
      <div class="filter-group">
        <label class="filter-label">Minimum Amount</label>
        <div class="input-with-icon">
          <i class="bi bi-currency-euro icon"></i>
          <input 
            #amountMinInput
            type="number" 
            class="form-control" 
            placeholder="0.00" 
            step="0.01"
            [value]="filters.amountMin || ''"
            (input)="onAmountMinChange($event)">
        </div>
      </div>

      <!-- Maximum amount -->
      <div class="filter-group">
        <label class="filter-label">Maximum Amount</label>
        <div class="input-with-icon">
          <i class="bi bi-currency-euro icon"></i>
          <input 
            #amountMaxInput
            type="number" 
            class="form-control" 
            placeholder="0.00" 
            step="0.01"
            [value]="filters.amountMax || ''"
            (input)="onAmountMaxChange($event)">
    </div>
      </div>
          </div>
        </div>

  <!-- Transactions Table -->
  <div class="table-section" *ngIf="!isLoading && !error">
    <div class="table-header">
      <h5><i class="bi bi-list me-2"></i>Transactions</h5>
      <div class="pagination-info">
        Page {{ currentPage }} of {{ totalPages }} 
        ({{ filteredTransactions.length }} results)
      </div>
    </div>

    <!-- No transactions message -->
    <div *ngIf="filteredTransactions.length === 0" class="no-data">
      <i class="bi bi-inbox-fill fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">No transactions found</h5>
      <p class="text-muted">Try adjusting the filters or add new transactions.</p>
    </div>

    <!-- Transactions table -->
    <div *ngIf="filteredTransactions.length > 0" class="table-responsive">
      <table class="transactions-table">
        <thead>
          <tr>
            <th><i class="bi bi-calendar me-2"></i>Date</th>
            <th><i class="bi bi-tag me-2"></i>Type</th>
            <th><i class="bi bi-text-left me-2"></i>Description</th>
            <th><i class="bi bi-credit-card me-2"></i>Account</th>
            <th><i class="bi bi-currency-euro me-2"></i>Amount</th>
            <th><i class="bi bi-receipt me-2"></i>Reference</th>
            <th><i class="bi bi-clock me-2"></i>Registered</th>
            <th><i class="bi bi-gear me-2"></i>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let transaction of paginatedTransactions; trackBy: trackByTransactionId" 
              class="transaction-row">
            <td class="date-cell">
              {{ formatDate(transaction.date) }}
            </td>
            <td class="type-cell">
              <span class="transaction-type">
                <i [class]="'bi ' + getTransactionIcon(transaction.type)"></i>
                {{ transaction.type }}
              </span>
            </td>
            <td class="description-cell">
              <span [title]="transaction.description">{{ transaction.description }}</span>
            </td>
            <td class="account-cell">
              <div class="account-info">
                <div class="account-name">{{ getAccountName(transaction.accountId!) }}</div>
                <div class="account-number">{{ getAccountNumber(transaction.accountId!) }}</div>
              </div>
            </td>
            <td class="amount-cell">
              <span [class]="'amount ' + getAmountClass(transaction.amount)">
                {{ formatAmount(transaction.amount) }}
              </span>
            </td>
            <td class="reference-cell">
              <span class="reference">{{ transaction.referenceId || 'N/A' }}</span>
            </td>
            <td class="register-date-cell">
              {{ formatDate(transaction.registerDate || transaction.date) }}
            </td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button 
                  class="btn btn-sm btn-outline-primary me-1" 
                  (click)="editTransaction(transaction)"
                  [title]="'Edit transaction'">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button 
                  class="btn btn-sm btn-outline-danger" 
                  (click)="deleteTransaction(transaction)"
                  [title]="'Delete transaction'">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
            </tr>
        </tbody>
          </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-section" *ngIf="totalPages > 1">
      <nav aria-label="Transaction pagination">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link" (click)="previousPage()">
              <i class="bi bi-chevron-left"></i>
              Previous
            </button>
          </li>

          <!-- First page -->
          <li *ngIf="pages[0] !== getVisiblePages()[0]" class="page-item">
            <button class="page-link" (click)="changePage(1)" [class.active]="currentPage === 1">1</button>
          </li>

          <!-- Ellipsis before visible pages -->
          <li *ngIf="getVisiblePages()[0] > 2" class="page-item disabled">
            <span class="page-link">...</span>
          </li>

          <!-- Visible pages -->
          <li *ngFor="let page of getVisiblePages()" class="page-item" [class.active]="page === currentPage">
            <button class="page-link" (click)="changePage(page)">{{ page }}</button>
          </li>

          <!-- Ellipsis after visible pages -->
          <li *ngIf="getVisiblePages().slice(-1)[0] < pages.length - 1" class="page-item disabled">
            <span class="page-link">...</span>
          </li>

          <!-- Last page -->
          <li *ngIf="pages[pages.length - 1] !== getVisiblePages()[getVisiblePages().length - 1]" class="page-item">
            <button class="page-link" (click)="changePage(pages.length)" [class.active]="currentPage === pages.length">
              {{ pages.length }}
            </button>
          </li>

          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <button class="page-link" (click)="nextPage()">
              Next
              <i class="bi bi-chevron-right"></i>
              </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Edit Transaction Modal -->
  <div class="modal fade custom-modal" id="editTransactionModal" tabindex="-1" *ngIf="editingTransaction">
    <div class="modal-dialog modal-lg">
      <div class="modal-content custom-modal-content">
        <div class="modal-header custom-modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil-square me-2"></i>Edit Transaction
          </h5>
          <button type="button" class="btn-close" (click)="closeEditModal()"></button>
        </div>
        <div class="modal-body custom-modal-body">
          <form [formGroup]="editTransactionForm" (ngSubmit)="saveTransaction()">
            <div class="row">
              <!-- Date -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Transaction Date</label>
                <input 
                  type="date" 
                  class="form-control custom-input" 
                  formControlName="date"
                  [class.is-invalid]="editTransactionForm.get('date')?.invalid && editTransactionForm.get('date')?.touched">
                <div class="invalid-feedback">
                  Date is required
                </div>
              </div>

              <!-- Type -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Transaction Type</label>
                <select 
                  class="form-select custom-select" 
                  formControlName="type"
                  [class.is-invalid]="editTransactionForm.get('type')?.invalid && editTransactionForm.get('type')?.touched">
                  <option value="">Select type...</option>
                  <option *ngFor="let type of getEditableTransactionTypes()" [value]="type">
                    {{ type }}
                  </option>
                </select>
                <div class="invalid-feedback">
                  Transaction type is required
                </div>
              </div>

              <!-- Description -->
              <div class="col-12 mb-3">
                <label class="form-label">Description</label>
                <input 
                  type="text" 
                  class="form-control custom-input" 
                  formControlName="description"
                  placeholder="Enter transaction description..."
                  [class.is-invalid]="editTransactionForm.get('description')?.invalid && editTransactionForm.get('description')?.touched">
                <div class="invalid-feedback">
                  Description is required
                </div>
              </div>

              <!-- Account -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Account</label>
                <select 
                  class="form-select custom-select" 
                  formControlName="accountId"
                  [class.is-invalid]="editTransactionForm.get('accountId')?.invalid && editTransactionForm.get('accountId')?.touched">
                  <option value="">Select account...</option>
                  <option *ngFor="let account of accounts" [value]="account.account_Id">
                    {{ account.holder_name }} - {{ account.account_number }}
                  </option>
                </select>
                <div class="invalid-feedback">
                  Account is required
                </div>
              </div>

              <!-- Amount -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Amount (€)</label>
                <input 
                  type="number" 
                  class="form-control custom-input" 
                  formControlName="amount"
                  placeholder="0.00"
                  step="0.01"
                  [class.is-invalid]="editTransactionForm.get('amount')?.invalid && editTransactionForm.get('amount')?.touched">
                <div class="invalid-feedback">
                  <!-- Mensajes de error más específicos -->
                  <span *ngIf="editTransactionForm.get('amount')?.errors?.['required']">
                    Amount is required
                  </span>
                  <span *ngIf="editTransactionForm.get('amount')?.errors?.['invalid']">
                    Please enter a valid number
                  </span>
                  <span *ngIf="editTransactionForm.get('amount')?.errors?.['tooSmall']">
                    Amount must be at least €0.01 (positive or negative)
                  </span>
                </div>
              </div>

              <!-- Reference ID -->
              <div class="col-12 mb-3">
                <label class="form-label">Reference ID (Optional)</label>
                <input 
                  type="text" 
                  class="form-control custom-input" 
                  formControlName="referenceId"
                  placeholder="Enter reference ID...">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer custom-modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
            <i class="bi bi-x-lg me-1"></i>Cancel
          </button>
          <button 
            type="button" 
            class="btn btn-primary" 
            (click)="saveTransaction()"
            [disabled]="editTransactionForm.invalid || isSaving">
            <i class="bi bi-check-lg me-1"></i>
            <span *ngIf="!isSaving">Save Changes</span>
            <span *ngIf="isSaving">Saving...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade custom-modal" id="deleteTransactionModal" tabindex="-1" *ngIf="deletingTransaction">
    <div class="modal-dialog">
      <div class="modal-content custom-modal-content">
        <div class="modal-header custom-modal-header">
          <h5 class="modal-title">
            <i class="bi bi-trash me-2 text-danger"></i>Delete Transaction
          </h5>
          <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
        </div>
        <div class="modal-body custom-modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This action cannot be undone.
          </div>
          <p>Are you sure you want to delete this transaction?</p>
          <div class="transaction-preview">
            <strong>{{ deletingTransaction.description }}</strong><br>
            <small class="text-muted">
              {{ formatDate(deletingTransaction.date) }} • 
              {{ formatAmount(deletingTransaction.amount) }} • 
              {{ deletingTransaction.type }}
            </small>
          </div>
        </div>
        <div class="modal-footer custom-modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">
            <i class="bi bi-x-lg me-1"></i>Cancel
          </button>
          <button 
            type="button" 
            class="btn btn-danger" 
            (click)="confirmDelete()"
            [disabled]="isDeleting">
            <i class="bi bi-trash me-1"></i>
            <span *ngIf="!isDeleting">Delete Transaction</span>
            <span *ngIf="isDeleting">Deleting...</span>
          </button>
        </div>
      </div>
          </div>
        </div>
      </div>

